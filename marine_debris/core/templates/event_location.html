{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="/site-media/third-party/OpenLayers-2.12/theme/default/style.css" type="text/css">
<link rel="stylesheet" href="/site-media/css/map_style.css" type="text/css">
{% endblock %}

{% block content %}
    <h1>WCGA Marine Debris Database</h1>
{% endblock %}    
{% block leftcontent %}
    <h2>Create a New Event</h2>
    <table>
    <tr><td>Organization: </td><td>{{event.organization}}</td></tr>
    <tr><td>Project: </td><td>{{event.project}}</td></tr>
    <tr><td>Date: </td><td>{{event.date}}</td></tr>
    <tr><td>Data Sheet: </td><td>{{event.data_sheet}}</td></tr>
    </table>
{% endblock %}    
{% block rightcontent %}
        <h2>Location</h2>
        <p>If you know the latitude and longitude of the derelict gear, enter it in the fields below. If not, select the approximate location on the map, and identify that this is an approximation using the checkbox below.</p>
        {% if error %}<p style="color:red">{{error}}</p>{% endif %}
        <form class="event-form" method="post" action="{% if action %}{{ action }}{% else %}/event/create/location{% endif %}">
        {% csrf_token %}
        {{form}}
        <div id="map" class="smallmap"></div>
        <p><button type="button" class="btn" id="back" value="Back" onClick="history.go(-1);return true;">Back</button>
        <input id="submit" type="submit" value="Continue" class='btn' style="margin:15px"/>
        </p>
        </form>
    
{% endblock %}    

{% block scripts %}
        <script>
            function updateCoordVals(lon, lat) {
                $( "#id_latitude" ).val(lat.toFixed(6));
                $( "#id_longitude" ).val(lon.toFixed(6));
            }
        </script>
        <script src="/site-media/third-party/OpenLayers-2.12/OpenLayers.js"></script>
        <script src="/site-media/js/widgets/map.js"></script>
{% endblock %}

{% block js %}
    
    $(document).ready(function () {
        $(".county-typeahead").typeahead({
            //source: {{sitenames|safe}}
            source: function () {
                return $.map(app.viewModel.selectedState().counties, function (county) {
                   return county.name;
                })
            }
        });
        $(".site-typeahead").typeahead({
            //source: {{sitenames|safe}}
            source: function () {
                return $.map(app.viewModel.selectedCounty().sites, function (site) {
                   return site.name;
                })
            }
        });            
    });
    

    var app = {}, 
        json = {
        "states" : [
            {
                "name" : "Washington",
                "initials": "WA",
                "counties": [
                    {
                        "name": "wa-1",
                        "sites": [
                            {
                                "name":"wa-1-1"
                            },{
                                "name":"wa-1-2"
                            }
                        ]
                    },{
                        "name": "wa-2",
                        "sites": [
                            {
                                "name":"wa-2-1"
                            },{
                                "name":"wa-2-2"
                            }
                        ]
                    }
                ]
            },{
                "name" : "Oregon",
                "initials": "OR",
                "counties": [
                    {
                        "name": "or-1",
                        "sites": [
                            {
                                "name":"or-1-1"
                            },{
                                "name":"or-1-2"
                            }
                        ]
                    },{
                        "name": "or-2",
                        "sites": [
                            {
                                "name":"or-2-1"
                            },{
                                "name":"or-2-2"
                            }
                        ]
                    }
                ]
            },{
                "name": "California",
                "initials": "CA",
                "counties": [
                    {
                        "name": "Santa Cruz",
                        "sites": [
                            {
                                "name": "Hidden Beach"
                            },{
                                "name": "Cowell Beach"
                            }
                        ]
                    },{
                        "name": "San Diego",
                        "sites": [
                            {
                                "name": "Coronado Beach"
                            },{
                                "name": "Pacific Beach"
                            }
                        ]
                    }
                ]
            }
        ]
    };

    function LocationViewModel() {
        var self = this;
        
        self.data = json;
        
        
        
        self.selectedStateName = ko.observable();
        self.selectedState = ko.computed(function() {
            var state = false;
            if (self.selectedStateName()){
                $.each(json.states, function(index, value) {
                    if (value.initials === self.selectedStateName()){
                        state = value;
                    }
                });
            }
            return state;
        });
        self.selectedCountyName = ko.observable();
        self.selectedCounty = ko.computed(function() {
            var county = false;
            if (self.selectedStateName() && self.selectedCountyName()) {
                $.each(self.selectedState().counties, function(index, value) {
                    if (value.name === self.selectedCountyName()){
                        county = value;
                    }
                });
            }
            return county;
        });
        self.selectedSiteName = ko.observable();
    }
    
    app.viewModel = new LocationViewModel();
    ko.applyBindings(app.viewModel);
    
    
    function onload(event) {
        init();
    }
    
    function latLonEdit() {
        var lat = $( "#id_latitude" ).val();
        var lon = $( "#id_longitude" ).val();
        if (lat != '' && lon != '') {
            pointSelected(lat, lon);
        }
    }

	$(function() {
		$( ".date" ).datepicker({dateFormat: 'yy-mm-dd'});
        $( "#id_site_name" ).on('blur', function(){
            var locations = {
            {% for site in sites %}
                '{{site.name}}': [{{site.lat}},{{site.lon}}],
            {% endfor %}
                'None': ['','']
            }, location = $(this).val();    // TODO: need to check state & county, too: this will get filtered!
            
            $( "#id_latitude" ).val(locations[location][0]);
            $( "#id_longitude" ).val(locations[location][1]);
            pointSelected(locations[location][0], locations[location][1]);
        });
      
        $( "#id_latitude" ).on('change', function(){
            latLonEdit();
        });
        $( "#id_longitude" ).on('change', function(){
            latLonEdit();
        });
        
    });
{% endblock %}